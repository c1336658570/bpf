```bash
/sys/kernel/debug/tracing/trace_pipe
/sys/kernel/debug/tracing/event/				# 内核支持的所有tracepoint的定义

# 可以通过查看 /sys/kernel/debug/tracing/available_events 文件的内容找到 tracepoint 可监控的事件。
sudo cat /sys/kernel/debug/tracing/available_events
# 每行内容的格式是:<category>:<name>
#tracepoint 事件对应的 SEC 格式为:SEC("tracepoint/<category>/<name>")

bpftool feature probe 							# 查看当前系统支持的辅助函数列表。
bpftool feature probe | grep map_type			# 查看支持的BPF映射
# 导出vmlinux.h
bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h
bpftool feature probe | grep program_type		# 程序可以挂载的事件类型和事件参数

sudo bpftrace -l
sudo bpftrace -l 'tracepoint:*' 
sudo bpftrace -l 'tracepoint:syscalls:*'
sudo bpftrace -l 'kprobe:*'

strace chmod 600 a.txt		# 确定chmod命令使用的系统调用，此命令输出太多使用下面的
strace chmod 600 1.txt 2>&1 | grep 'fchmodat'
strace -e trace=fchmodat  chmod 600 1.txt
# 查看fchmodat的tracepoint点
sudo cat /sys/kernel/debug/tracing/available_events | grep fchmodat	

# 对每个跟踪点都会有一个对应的格式文件，例如：
# 查看tracepoint中的/syscalls/sys_enter_fchmodat的ebpf程序可以获取哪些信息
sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format
# 查看tracepoint中的sched/sched_process_exec的格式信息
sudo cat /sys/kernel/debug/tracing/events/sched/sched_process_exec/format
```



### 如何确定 tracepoint 事件处理函数的参数类型，获取对应的内核调用参数

假设，我们想通过 tracepoint 监控 `chmod` 这个命令涉及的 `fchmodat` 系统调用

先确定 `chmod` 所使用的系统调用，这个比较简单，有很多种方法可以做到，比如通过 `strace` 命令:

```bash
strace chmod 600 a.txt	# 此命令输出太多使用下面的
strace chmod 600 1.txt 2>&1 | grep 'fchmodat'
```

第二步，找到针对这个系统调用可以使用的 tracepoint 事件:

```bash
sudo cat /sys/kernel/debug/tracing/available_events | grep fchmodat
```

第三步，确定函数的参数类型。这个需要到 `vmlinux.h` 文件中进行查找， 一般 `sys_enter_xx` 对应 `trace_event_raw_sys_enter` ， `sys_exit_xx` 对应 `trace_event_raw_sys_exit` ， 其他的一般对应 `trace_event_raw_<name>` ，如果没找到的话，可以参考 `trace_event_raw_sys_enter` 的例子找它相近的 struct。 对于 `sys_enter_fchmodat` ，我们使用 `trace_event_raw_sys_enter` 这个 struct

```c
struct trace_event_raw_sys_enter {
    struct trace_entry ent;
    long int id;
    long unsigned int args[6];
    char __data[0];
};
```

其中 `args` 中就存储了事件相关的我们可以获取的信息，至于里面包含了哪些信息就是第四步需要确定的信息。

第四步，确定事件本身可以获取到哪些信息，虽然我们知道 `fchmodat` 系统调用需要提供文件名称和 mode 信息， 但是，我们不确定是否可以在 ebpf 程序中获取到这些信息。可以通过查看 `/sys/kernel/debug/tracing/events/<category>/<name>/format` 文件获取到我们可以获取哪些信息。 比如 `sys_enter_fchmodat` 这个事件的 `/sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format` 的内容如下:

```bash
sudo cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_fchmodat/format
```

`print fmt` 中引用的字段都是我们可以在 ebpf 程序中获取的信息。 从上面可以看到，我们可以获取 `sys_enter_fchmodat` 事件的 `dfd` 、 `filename` 以及 `mode` 信息， 这里就包含了前面所说的文件名称以及权限 mode 信息。 这些字段的值可以通过 `trace_event_raw_sys_enter` 的 `args` 数组获取，即通过 `args[0]` 获取 `dfd` , `args[1]` 获取 `filename` 以此类推。
